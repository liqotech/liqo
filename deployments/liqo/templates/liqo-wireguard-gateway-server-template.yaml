{{- $templateConfig := (merge (dict "name" "wireguard-server" "module" "networking") .) -}}

{{- if .Values.networking.internal }}

apiVersion: networking.liqo.io/v1alpha1
kind: WgGatewayServerTemplate
metadata:
  name: {{ $templateConfig.name  }}
  labels:
    {{- include "liqo.labels" $templateConfig | nindent 4 }}
spec:
  objectKind:
    apiVersion: networking.liqo.io/v1alpha1
    kind: WgGatewayServer
  template:
    metadata:
      {{- include "liqo.metadataTemplate" $templateConfig | nindent 6 }}
    spec:
      service:
        metadata:
          {{- include "liqo.metadataTemplate" $templateConfig | nindent 12 }}
        spec:
          selector:
            {{- include "liqo.labelsTemplate" $templateConfig | nindent 12 }}
          type: "{{"{{ .Spec.Endpoint.ServiceType }}"}}"
          ports:
          - port: "{{"{{ .Spec.Endpoint.Port }}"}}"
            protocol: UDP
            targetPort: "{{"{{ .Spec.Endpoint.Port }}"}}"
          {{- if .Values.networking.gateway.server.service.allocateLoadBalancerNodePorts }}
          allocateLoadBalancerNodePorts: {{ .Values.networking.gateway.server.service.allocateLoadBalancerNodePorts }}
          {{- end }}
      deployment:
        metadata:
          {{- include "liqo.metadataTemplate" $templateConfig | nindent 10 }}
        spec:
          replicas: {{ .Values.networking.gateway.replicas }}
          selector:
            matchLabels:
              {{- include "liqo.labelsTemplate" $templateConfig | nindent 14 }}
          template:
            metadata:
              {{- include "liqo.metadataTemplate" $templateConfig | nindent 14 }}
            spec:
              serviceAccount: "{{"{{ .Name }}"}}"
              serviceAccountName: "{{"{{ .Name }}"}}"
              containers:
              - name: gateway
                image: ghcr.io/liqotech/gateway{{ include "liqo.suffix" $templateConfig }}:{{ include "liqo.version" $templateConfig }}
                imagePullPolicy: {{ .Values.pullPolicy }}
                args:
                - --name={{"{{ .Name }}"}}
                - --namespace={{"{{ .Namespace }}"}}
                - --remote-cluster-id={{"{{ .ClusterID }}"}}
                - --gateway-uid={{"{{ .GatewayUID }}"}}
                - --mode=server
                - --metrics-address=:8080
                - --health-probe-bind-address=:8081
                - --ping-enabled=true
                - --ping-loss-threshold={{ .Values.networking.gateway.ping.lossThreshold }}
                - --ping-interval={{ .Values.networking.gateway.ping.interval }}
                - --ping-update-status-interval={{ .Values.networking.gateway.ping.updateStatusInterval }}
                {{- if gt .Values.networking.gateway.replicas 1.0 }}
                - --leader-election=true
                {{- end }}
                securityContext:
                  capabilities:
                    add:
                    - NET_ADMIN
                    - NET_RAW
              - name: wireguard
                image: ghcr.io/liqotech/gateway/wireguard{{ include "liqo.suffix" $templateConfig }}:{{ include "liqo.version" $templateConfig }}
                imagePullPolicy: {{ .Values.pullPolicy }}
                args:
                - --name={{"{{ .Name }}"}}
                - --namespace={{"{{ .Namespace }}"}}
                - --remote-cluster-id={{"{{ .ClusterID }}"}}
                - --gateway-uid={{"{{ .GatewayUID }}"}}
                - --mode=server
                - --mtu={{"{{ .Spec.MTU }}"}}
                - --listen-port={{"{{ .Spec.Endpoint.Port }}"}}
                - --metrics-address=:8082
                - --health-probe-bind-address=:8083
                securityContext:
                  capabilities:
                    add:
                    - NET_ADMIN
                    - NET_RAW
{{- end }}
